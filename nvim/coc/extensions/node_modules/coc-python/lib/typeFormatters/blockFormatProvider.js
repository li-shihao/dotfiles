"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const coc_nvim_1 = require("coc.nvim");
const codeBlockFormatProvider_1 = require("./codeBlockFormatProvider");
const contracts_1 = require("./contracts");
class BlockFormatProviders {
    constructor() {
        this.providers = [];
        const boundaryBlocks = [
            contracts_1.DEF_REGEX,
            contracts_1.ASYNC_DEF_REGEX,
            contracts_1.CLASS_REGEX
        ];
        const elseParentBlocks = [
            contracts_1.IF_REGEX,
            contracts_1.ELIF_REGEX,
            contracts_1.FOR_IN_REGEX,
            contracts_1.ASYNC_FOR_IN_REGEX,
            contracts_1.WHILE_REGEX,
            contracts_1.TRY_REGEX,
            contracts_1.EXCEPT_REGEX
        ];
        this.providers.push(new codeBlockFormatProvider_1.CodeBlockFormatProvider(contracts_1.ELSE_REGEX, elseParentBlocks, boundaryBlocks));
        const elifParentBlocks = [
            contracts_1.IF_REGEX,
            contracts_1.ELIF_REGEX
        ];
        this.providers.push(new codeBlockFormatProvider_1.CodeBlockFormatProvider(contracts_1.ELIF_REGEX, elifParentBlocks, boundaryBlocks));
        const exceptParentBlocks = [
            contracts_1.TRY_REGEX,
            contracts_1.EXCEPT_REGEX
        ];
        this.providers.push(new codeBlockFormatProvider_1.CodeBlockFormatProvider(contracts_1.EXCEPT_REGEX, exceptParentBlocks, boundaryBlocks));
        const finallyParentBlocks = [
            contracts_1.TRY_REGEX,
            contracts_1.EXCEPT_REGEX
        ];
        this.providers.push(new codeBlockFormatProvider_1.CodeBlockFormatProvider(contracts_1.FINALLY_REGEX, finallyParentBlocks, boundaryBlocks));
    }
    provideOnTypeFormattingEdits(document, position, ch, options, _token) {
        if (position.line === 0) {
            return [];
        }
        let doc = coc_nvim_1.workspace.getDocument(document.uri);
        if (!doc)
            return [];
        const currentLine = doc.getline(position.line);
        const prevousLine = doc.getline(position.line - 1);
        // We're only interested in cases where the current block is at the same indentation level as the previous line
        // E.g. if we have an if..else block, generally the else statement would be at the same level as the code in the if...
        if (currentLine.match(/^\s*/)[0] !== prevousLine.match(/^\s*/)[0]) {
            return [];
        }
        const provider = this.providers.find(p => p.canProvideEdits(currentLine));
        if (provider)
            return provider.provideEdits(document, position, ch, options, currentLine);
        return [];
    }
}
exports.BlockFormatProviders = BlockFormatProviders;
//# sourceMappingURL=blockFormatProvider.js.map